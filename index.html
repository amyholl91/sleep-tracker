<!-- 
    STEP 46: Calendar Mobile Fix
    - Reduced gap from 5px to 3px
    - Reduced padding from 15px to 8px
    - Smaller day headers (0.75em font)
    - Smaller day cells (0.95em numbers, 0.65em hours)
    - Reduced cell padding from 8px to 4px
    - Today border from 3px to 2px
    - Added min-width: 0 to prevent overflow
    - All 7 days now fit on mobile screen!
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infant Sleep Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 120px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .baby-info-bar {
            background: #f0f4ff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #e0e7ff;
        }

        .baby-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .baby-info-item span {
            font-size: 1.1em;
            color: #4338ca;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            position: relative;
        }

        .date-nav button {
            padding: 8px 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
        }

        .date-nav button:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
        }

        .date-nav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .date-nav h2 {
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .today-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.6em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .next-sleep-window {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
        }

        .next-sleep-window.passed {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .next-sleep-window.sleeping {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .next-sleep-window h3 {
            font-size: 1.3em;
            margin-bottom: 8px;
        }

        .next-sleep-time {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .next-sleep-countdown {
            font-size: 1em;
            opacity: 0.95;
        }

        .nap-alert {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .nap-alert h3 {
            font-size: 1.3em;
            margin-bottom: 8px;
        }

        .nap-alert-time {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .nap-alert-message {
            font-size: 1em;
            opacity: 0.95;
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            box-sizing: border-box;
            max-width: 100%;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #667eea;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 0 0 20px 0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
            box-sizing: border-box;
            max-width: 100%;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .radio-option input[type="radio"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            margin: 0;
        }

        .radio-option.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        button.primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        button.primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        button.secondary-btn {
            background: white;
            color: #667eea;
            padding: 10px 25px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button.secondary-btn:hover {
            background: #667eea;
            color: white;
        }

        button.start-nap-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button.start-nap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        button.end-nap-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button.end-nap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        button.edit-btn {
            background: #f59e0b;
            color: white;
            padding: 6px 15px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button.edit-btn:hover {
            background: #d97706;
        }

        button.delete-btn {
            background: #ef4444;
            color: white;
            padding: 6px 15px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button.delete-btn:hover {
            background: #dc2626;
        }

        .summary-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 15px 20px;
            color: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .summary-bar.poor {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .summary-bar.good {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .summary-bar-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-title {
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .active-nap {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .active-nap h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .active-nap-time {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .active-nap-duration {
            font-size: 1em;
            opacity: 0.95;
            margin-bottom: 15px;
        }

        .active-nap-edit {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .active-nap-edit input {
            background: white;
            color: #333;
        }

        .saved-nap {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #8b5cf6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-nap.short-nap {
            border-left: 4px solid #f59e0b;
            opacity: 0.8;
        }

        .saved-nap-info h4 {
            color: #8b5cf6;
            margin-bottom: 5px;
            font-size: 1.05em;
        }

        .saved-nap.short-nap .saved-nap-info h4 {
            color: #f59e0b;
        }

        .saved-nap-details {
            color: #666;
            font-size: 0.9em;
        }

        .saved-nap-actions {
            display: flex;
            gap: 8px;
        }

        .nap-duration {
            background: #e0e7ff;
            color: #4338ca;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .short-nap-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
        }

        .sleep-entry {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .sleep-entry:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .sleep-entry h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .entry-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            font-size: 14px;
        }

        .entry-detail {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .entry-detail strong {
            color: #333;
            display: block;
            margin-bottom: 4px;
        }

        .no-entries {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 1.1em;
        }

        .nap-planner-card {
            background: #f0f4ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e7ff;
        }

        .nap-schedule {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .nap-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #8b5cf6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nap-item h4 {
            color: #8b5cf6;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .nap-time {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .wake-window-info {
            background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .wake-window-info h4 {
            color: #4338ca;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .wake-window-info p {
            color: #4338ca;
            margin-bottom: 8px;
        }

        .setup-prompt {
            background: #fff7ed;
            border: 2px solid #fed7aa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-prompt h3 {
            color: #ea580c;
            margin-bottom: 10px;
        }

        .location-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .location-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: center;
        }

        .location-btn:hover {
            border-color: #8b5cf6;
            background: #f3e8ff;
        }

        .location-btn.selected {
            background: #8b5cf6;
            border-color: #8b5cf6;
            color: white;
        }

        .bedtime-input-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            box-sizing: border-box;
            max-width: 100%;
            overflow: hidden;
        }

        .bedtime-input-group label {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-option.checked {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        /* Hamburger Menu Button */
        .hamburger-menu-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            width: 50px;
            height: 50px;
            font-size: 1.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hamburger-menu-btn:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .header {
            position: relative;
            padding: 30px 80px;
        }

        /* Navigation Menu Styles */
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .nav-overlay.active {
            display: block;
        }

        .nav-menu {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            max-width: 80vw;
            height: 100vh;
            background: white;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .nav-menu.active {
            left: 0;
        }

        .nav-menu-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-menu-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .nav-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-menu-content {
            padding: 10px 0;
        }

        .nav-menu-item {
            width: 100%;
            padding: 18px 25px;
            background: white;
            border: none;
            border-left: 4px solid transparent;
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
        }

        .nav-menu-item:hover {
            background: #f5f5f5;
            border-left-color: #667eea;
        }

        .nav-menu-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
            font-weight: 600;
            color: #667eea;
        }

        /* Settings Menu Styles */
        .settings-menu-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .settings-menu-btn:hover {
            transform: scale(1.1);
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-menu {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-menu.active {
            right: 0;
        }

        .settings-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .settings-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
            }

            .container {
                border-radius: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .baby-info-bar {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }

            .baby-info-item {
                font-size: 0.9em;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
                padding: 10px;
            }

            .nav-tab {
                flex: 1 1 45%;
                font-size: 0.85em;
                padding: 10px 8px;
            }

            .content {
                padding: 15px;
            }

            .card {
                padding: 15px;
                margin: 0 0 15px 0;
            }

            .card-header {
                font-size: 1em;
                padding: 8px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .form-group {
                margin: 0;
                padding: 0;
            }

            .form-group label {
                font-size: 0.9em;
                margin-bottom: 4px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .date-nav {
                gap: 10px;
            }

            .date-nav button {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .date-nav h2 {
                font-size: 1em;
            }

            .location-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .location-btn {
                font-size: 0.85em;
                padding: 10px;
            }

            .saved-nap {
                flex-direction: column;
                gap: 10px;
            }

            .saved-nap-actions {
                width: 100%;
                justify-content: space-between;
            }

            /* Make night sleep section more compact */
            .form-group input[type="datetime-local"] {
                padding: 3px 4px;
                font-size: 12px;
                font-weight: normal;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .form-group input[type="text"],
            .form-group input[type="time"],
            .form-group input[type="number"] {
                padding: 5px;
                font-size: 13px;
                font-weight: normal;
                max-width: 100%;
                box-sizing: border-box;
                width: 100%;
            }

            .form-group textarea {
                padding: 5px;
                font-size: 13px;
                font-weight: normal;
                min-height: 50px;
                max-width: 100%;
                box-sizing: border-box;
                width: 100%;
            }

            .form-group label {
                font-size: 0.9em;
                font-weight: 600;
            }

            /* Make wake window more compact on mobile */
            .next-sleep-window {
                padding: 12px;
                margin-bottom: 12px;
            }

            .next-sleep-window h3 {
                font-size: 1em;
                margin-bottom: 4px;
            }

            .next-sleep-time {
                font-size: 1.8em;
                margin: 6px 0;
            }

            .next-sleep-countdown {
                font-size: 0.9em;
            }

            .nap-alert {
                padding: 12px;
                margin-bottom: 12px;
            }

            .nap-alert h3 {
                font-size: 1em;
            }

            .nap-alert-time {
                font-size: 1.6em;
            }

            /* Lighter button styling */
            .primary-btn,
            .secondary-btn,
            .start-nap-btn {
                font-weight: 500;
            }

            .location-btn {
                font-weight: 500;
            }

            .next-sleep-time,
            .nap-alert-time {
                font-size: 2em;
            }

            /* Make summary bar much more compact */
            #summary-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }

            .summary-bar {
                padding: 10px;
            }

            .summary-bar-content {
                flex-direction: row;
                gap: 8px;
                align-items: center;
            }

            .summary-title {
                font-size: 0.9em;
                margin-bottom: 5px;
            }

            .summary-stats {
                flex-direction: row;
                gap: 8px;
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .stat-item {
                min-width: 70px;
                flex-shrink: 0;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .primary-btn,
            .secondary-btn {
                font-size: 0.85em;
                padding: 10px 16px;
                font-weight: 500;
            }

            .start-nap-btn {
                font-size: 0.95em;
                padding: 12px 20px;
                font-weight: 500;
            }

            .edit-btn,
            .delete-btn {
                font-size: 0.8em;
                padding: 6px 10px;
            }

            /* Make tables/charts scrollable on mobile */
            canvas {
                max-width: 100%;
                height: auto !important;
            }

            /* Adjust sleep entry details for mobile */
            .entry-details {
                grid-template-columns: 1fr;
            }

            /* Stack radio options vertically on very small screens */
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }

            .radio-option {
                width: 100%;
            }
        }

        /* Extra small phones */
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .nav-tab {
                font-size: 0.75em;
                padding: 8px 5px;
            }

            .location-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="hamburger-menu-btn" onclick="toggleNavMenu()">
                ‚ò∞
            </button>
            <div>
                <h1>üåô Sweet Dreams Sleep Tracker üí§</h1>
                <p>Tracking precious sleep moments</p>
            </div>
        </div>

        <div class="baby-info-bar">
            <div class="baby-info-item">
                <span>üë∂</span>
                <span id="baby-display-name">Baby</span>
            </div>
            <div class="baby-info-item">
                <span>üìÖ</span>
                <span id="baby-display-age">Set up baby info</span>
            </div>
        </div>

        <div class="content">
            <!-- Sleep Tracker Tab -->
            <div id="tracker-tab" class="tab-content active">
                <div class="date-nav">
                    <button id="prev-date">‚Üê Previous</button>
                    <h2 id="current-date-display"></h2>
                    <button id="next-date">Next ‚Üí</button>
                </div>

                <div id="setup-section"></div>

                <div id="next-sleep-window-display"></div>
                
                <div id="nap-alert-display"></div>

                <div class="card">
                    <div class="card-header">
                        üåô Last Night's Sleep
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>üåÉ Bedtime</label>
                            <input type="datetime-local" id="bedtime">
                        </div>
                        <div class="form-group">
                            <label>‚òÄÔ∏è Wake Time</label>
                            <input type="datetime-local" id="wake-time">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>üöø Bath Last Night?</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="bath" value="yes">
                                    <span>Yes üõÅ</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="bath" value="no">
                                    <span>No</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>üõèÔ∏è Transferred</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="transferred" value="awake">
                                    <span>Awake üëÄ</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="transferred" value="asleep">
                                    <span>Asleep üò¥</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üåÉ Night Wake-ups</label>
                        <div id="saved-wakeups-list"></div>
                        
                        <div id="manual-wakeup-entry" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>‚è∞ Wake-up Start</label>
                                    <input type="time" id="wakeup-start">
                                </div>
                                <div class="form-group">
                                    <label>‚è∞ Back to Sleep</label>
                                    <input type="time" id="wakeup-end">
                                </div>
                            </div>
                            <div id="wakeup-duration-display" style="text-align: center; margin: 10px 0; font-weight: 600; color: #667eea;"></div>
                            <button class="secondary-btn" id="save-wakeup-btn" style="width: 100%; margin-top: 10px;">üíæ Save Wake-up</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üõèÔ∏è Came to Mom & Dad's Bed</label>
                        <input type="text" id="came-to-bed" placeholder="e.g., 4:30am">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        ‚òÄÔ∏è Today's Naps
                    </div>

                    <div id="active-nap-display"></div>
                    <div id="saved-naps-list"></div>

                    <div id="manual-nap-entry">
                        <div class="form-row">
                            <div class="form-group">
                                <label>‚è∞ Nap Start</label>
                                <input type="time" id="nap-start">
                            </div>
                            <div class="form-group">
                                <label>‚è∞ Nap End</label>
                                <input type="time" id="nap-end">
                            </div>
                        </div>

                        <div id="nap-duration-display"></div>

                        <div class="form-group">
                            <label>üìç Where did baby nap?</label>
                            <div class="location-buttons">
                                <button class="location-btn" data-location="crib">üõèÔ∏è Crib</button>
                                <button class="location-btn" data-location="stroller">üöº Stroller</button>
                                <button class="location-btn" data-location="car">üöó Car</button>
                                <button class="location-btn" data-location="carrier">üë∂ Carrier</button>
                                <button class="location-btn" data-location="contact">ü§± Contact</button>
                                <button class="location-btn" data-location="other">üìç Other</button>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" id="short-nap-checkbox">
                                <span>‚ö†Ô∏è Short nap (under 45 min - not restorative)</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>üí≠ Nap Notes</label>
                            <textarea id="nap-notes" placeholder="Any notes about this nap? (e.g., Woke crying, slept through loud noise, etc.)" style="min-height: 60px;"></textarea>
                        </div>

                        <button class="secondary-btn" id="save-nap-btn" style="width: 100%; margin-top: 15px;">üíæ Save Nap</button>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button class="start-nap-btn" id="start-nap-btn">‚ñ∂Ô∏è Start Nap Now</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        üìù Notes
                    </div>

                    <div class="form-group">
                        <label>üéµ Bedtime Routine</label>
                        <textarea id="bedtime-routine" placeholder="What was your bedtime routine? (e.g., Bath, bottle, book, lullaby, bed)"></textarea>
                    </div>

                    <div class="form-group">
                        <label>üí≠ Additional Notes</label>
                        <textarea id="notes" placeholder="Any observations, challenges, or successes today?"></textarea>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        üåô Actual Bedtime Tonight
                    </div>
                    
                    <div class="bedtime-input-group">
                        <div id="logged-bedtime-display" style="display: none; background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 1.1em; font-weight: 600; color: #667eea;">
                                    ‚úÖ Bedtime Logged
                                </div>
                                <button onclick="editLoggedBedtime()" style="
                                    padding: 6px 12px;
                                    background: #667eea;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 0.85em;
                                    cursor: pointer;
                                ">
                                    ‚úèÔ∏è Edit
                                </button>
                            </div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="logged-bedtime-text">
                                8:45 PM
                            </div>
                        </div>
                        
                        <label>‚è∞ What time did baby actually fall asleep tonight?</label>
                        <input type="datetime-local" id="tonight-bedtime" style="font-size: 1.2em; padding: 15px; width: 100%; max-width: 100%; box-sizing: border-box;" onchange="updateLoggedBedtimeDisplay()">
                        <p style="color: #666; font-size: 0.9em; margin-top: 8px;">This will auto-populate into tomorrow's "Last Night's Bedtime"</p>
                    </div>
                </div>
            </div>

            <!-- Nap Planner Tab -->
            <div id="planner-tab" class="tab-content">
                <div id="planner-setup-section"></div>

                <div class="card">
                    <div class="card-header">
                        üìÖ Plan Naps Around Events
                    </div>
                    
                    <div class="form-group">
                        <label>üéØ What do you need to plan around?</label>
                        <select id="event-type" style="font-size: 1.1em;">
                            <option value="">Select event type...</option>
                            <option value="appointment">üè• Appointment - Need baby asleep DURING</option>
                            <option value="dinner">üçΩÔ∏è Dinner Plans - Need baby asleep BEFORE you leave</option>
                            <option value="errand">üõí Errand - Need baby asleep DURING</option>
                        </select>
                    </div>

                    <div id="event-details" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label id="event-time-label">‚è∞ Event Time</label>
                                <input type="time" id="event-time">
                            </div>
                            <div class="form-group">
                                <label>‚è±Ô∏è Duration (minutes)</label>
                                <input type="number" id="event-duration" placeholder="e.g., 60" min="15" step="5">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üìù Event Description (optional)</label>
                            <input type="text" id="event-description" placeholder="e.g., Doctor appointment, Dinner at Joe's, Target run">
                        </div>

                        <button class="primary-btn" onclick="calculateNapPlan()" style="width: 100%; margin-top: 15px;">
                            üßÆ Calculate Nap Plan
                        </button>
                    </div>
                </div>

                <div id="nap-plan-results"></div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="changeHistoryMonth(-1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚Üê Prev
                        </button>
                        <h3 id="history-month-display" style="margin: 0;"></h3>
                        <button onclick="changeHistoryMonth(1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Next ‚Üí
                        </button>
                    </div>
                    
                    <div id="history-calendar"></div>
                </div>
                
                <div id="history-day-detail" style="display: none;">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="history-detail-date" style="margin: 0;"></h3>
                            <button onclick="closeHistoryDetail()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‚úï Close
                            </button>
                        </div>
                        <div style="text-align: center; margin: 15px 0;">
                            <button class="primary-btn" onclick="editHistoryDate()" style="padding: 12px 30px;">
                                ‚úèÔ∏è Edit This Day
                            </button>
                        </div>
                        <div id="history-entries"></div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trends-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        üìÖ Weekly Sleep Schedule
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <button onclick="changeWeek(-1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚Üê Previous
                        </button>
                        <div id="week-display" style="font-weight: 600; font-size: 1.1em;"></div>
                        <button onclick="changeWeek(1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Next ‚Üí
                        </button>
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <div id="weekly-schedule"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        üìà Sleep Trends (Last 7 Days)
                    </div>
                    <canvas id="sleep-chart" style="max-height: 400px;"></canvas>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        üìä Sleep Statistics
                    </div>
                    <div id="sleep-stats"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Navigation Slide-Out Menu -->
    <div id="nav-overlay" class="nav-overlay" onclick="toggleNavMenu()"></div>
    <div id="nav-menu" class="nav-menu">
        <div class="nav-menu-header">
            <h2>üìã Menu</h2>
            <button class="nav-close-btn" onclick="toggleNavMenu()">‚úï</button>
        </div>
        
        <div class="nav-menu-content">
            <button class="nav-menu-item active" data-tab="tracker" onclick="switchTabFromMenu('tracker')">
                üí§ Sleep Tracker
            </button>
            <button class="nav-menu-item" data-tab="planner" onclick="switchTabFromMenu('planner')">
                üìã Nap Planner
            </button>
            <button class="nav-menu-item" data-tab="history" onclick="switchTabFromMenu('history')">
                üìä History
            </button>
            <button class="nav-menu-item" data-tab="trends" onclick="switchTabFromMenu('trends')">
                üìà Trends
            </button>
            <button class="nav-menu-item" onclick="openSettingsFromNav()">
                ‚öôÔ∏è Settings
            </button>
        </div>
    </div>

    <!-- Settings Slide-Out Menu -->
    <div id="settings-overlay" class="settings-overlay" onclick="toggleSettingsMenu()"></div>
    <div id="settings-menu" class="settings-menu">
        <div class="settings-header">
            <h2>‚öôÔ∏è Settings</h2>
            <button class="settings-close-btn" onclick="toggleSettingsMenu()">‚úï</button>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <h3>üë∂ Baby Information</h3>
                <div class="form-group">
                    <label>Baby's Name</label>
                    <input type="text" id="settings-name" placeholder="Enter baby's name">
                </div>
                
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="settings-dob">
                </div>
                
                <div class="form-group">
                    <label>üåô Preferred Bedtime (for nap planning)</label>
                    <input type="time" id="settings-bedtime">
                </div>
                
                <button class="primary-btn" onclick="updateBabySettings()" style="width: 100%; margin-top: 15px;">
                    üíæ Save Settings
                </button>
            </div>

            <div class="settings-section">
                <h3>üíæ Backup & Restore</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                    Your data is saved on this device. Back it up regularly!
                </p>
                
                <button class="primary-btn" onclick="exportData()" style="width: 100%; margin-bottom: 10px;">
                    üì• Download Backup
                </button>
                
                <button class="secondary-btn" onclick="document.getElementById('import-file').click()" style="width: 100%;">
                    üì§ Import Backup
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>

            <div class="settings-section">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <p style="color: #dc2626; margin-bottom: 10px; font-size: 0.9em;">
                    This will delete ALL sleep data permanently!
                </p>
                
                <button class="secondary-btn" onclick="clearAllData()" style="width: 100%; background: #dc2626; color: white; border: none;">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
        </div>
    </div>

    <div id="summary-bar"></div>

    <script>
        // Initialize currentDate in local timezone
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        let currentDate = `${year}-${month}-${day}`;
        
        let currentTab = 'tracker';
        let savedNaps = [];
        let savedWakeups = [];
        let editingNapIndex = -1;
        let editingWakeupIndex = -1;
        let selectedLocation = '';
        let sleepWindowInterval;
        let activeNapInterval;
        let activeNap = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeTrackerTab();
            initializePlannerTab();
            // History tab now uses calendar view
            updateDateDisplay();
            loadBabyInfo();
            loadDailySleepData();
            setupRadioButtons();
            setupLocationButtons();
            setupNapInputs();
            setupCheckbox();
            updateNextSleepWindow();
            updateLoggedBedtimeDisplay();
            startSleepWindowTimer();
        });

        function setupCheckbox() {
            const checkbox = document.getElementById('short-nap-checkbox');
            const label = checkbox.closest('.checkbox-option');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
            });
        }

        function loadDailySleepData() {
            const key = `daily-sleep-${currentDate}`;
            const stored = localStorage.getItem(key);
            
            // Clear all form fields first
            document.getElementById('bedtime').value = '';
            document.getElementById('wake-time').value = '';
            document.getElementById('came-to-bed').value = '';
            document.getElementById('bedtime-routine').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('tonight-bedtime').value = '';
            savedNaps = [];
            savedWakeups = [];
            
            // Clear radio buttons
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            if (stored) {
                const data = JSON.parse(stored);
                document.getElementById('bedtime').value = data.bedtime || '';
                document.getElementById('wake-time').value = data.wakeTime || '';
                document.getElementById('came-to-bed').value = data.cameToBed || '';
                document.getElementById('bedtime-routine').value = data.bedtimeRoutine || '';
                document.getElementById('notes').value = data.notes || '';
                document.getElementById('tonight-bedtime').value = data.tonightBedtime || '';
                
                if (data.bath) {
                    const bathRadio = document.querySelector(`input[name="bath"][value="${data.bath}"]`);
                    if (bathRadio) {
                        bathRadio.checked = true;
                        bathRadio.closest('.radio-option').classList.add('selected');
                    }
                }
                
                if (data.transferred) {
                    const transferredRadio = document.querySelector(`input[name="transferred"][value="${data.transferred}"]`);
                    if (transferredRadio) {
                        transferredRadio.checked = true;
                        transferredRadio.closest('.radio-option').classList.add('selected');
                    }
                }
                
                if (data.wakeups) {
                    savedWakeups = data.wakeups;
                }
                
                if (data.naps) {
                    savedNaps = data.naps;
                    // Sort naps by start time when loading
                    savedNaps.sort((a, b) => {
                        const timeA = a.start.split(':').map(Number);
                        const timeB = b.start.split(':').map(Number);
                        const minutesA = timeA[0] * 60 + timeA[1];
                        const minutesB = timeB[0] * 60 + timeB[1];
                        return minutesA - minutesB;
                    });
                }
            } else {
                setDefaultDatetimes();
            }
            
            renderSavedNaps();
            renderSavedWakeups();
            updateSummary();
        }

        function saveDailySleepData() {
            const key = `daily-sleep-${currentDate}`;
            const data = {
                bedtime: document.getElementById('bedtime').value,
                wakeTime: document.getElementById('wake-time').value,
                bath: document.querySelector('input[name="bath"]:checked')?.value || '',
                transferred: document.querySelector('input[name="transferred"]:checked')?.value || '',
                wakeups: savedWakeups,
                cameToBed: document.getElementById('came-to-bed').value,
                naps: savedNaps,
                bedtimeRoutine: document.getElementById('bedtime-routine').value,
                notes: document.getElementById('notes').value,
                tonightBedtime: document.getElementById('tonight-bedtime').value
            };
            
            localStorage.setItem(key, JSON.stringify(data));
        }

        function startSleepWindowTimer() {
            sleepWindowInterval = setInterval(updateNextSleepWindow, 60000);
        }

        function updateActiveNapDisplay() {
            const display = document.getElementById('active-nap-display');
            
            if (!activeNap) {
                display.innerHTML = '';
                return;
            }

            const now = new Date();
            const start = new Date(activeNap.startTime);
            const duration = now - start;
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));

            const locationEmoji = {
                'crib': 'üõèÔ∏è',
                'stroller': 'üöº',
                'car': 'üöó',
                'carrier': 'üë∂',
                'contact': 'ü§±',
                'other': 'üìç'
            };

            const startTimeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            display.innerHTML = `
                <div class="active-nap">
                    <h4 style="margin-bottom: 15px;">üò¥ Nap in Progress</h4>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85em; margin-bottom: 5px;">Started at</div>
                        <input type="time" id="active-nap-start-edit" value="${start.toTimeString().slice(0, 5)}" 
                            onchange="updateActiveNapStartTime(this.value)"
                            style="
                                font-size: 1.8em;
                                font-weight: bold;
                                color: white;
                                background: rgba(255,255,255,0.15);
                                border: 2px solid rgba(255,255,255,0.3);
                                border-radius: 10px;
                                padding: 8px 12px;
                                text-align: center;
                                max-width: 180px;
                                width: auto;
                                margin: 0 auto;
                                display: block;
                                box-sizing: border-box;
                            ">
                    </div>
                    
                    <div style="text-align: center; font-size: 1.5em; font-weight: 600; margin-bottom: 15px;">
                        Duration: ${hours > 0 ? hours + 'h ' : ''}${minutes}m
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px; font-size: 1.1em;">
                        ${locationEmoji[activeNap.location]} ${activeNap.location}
                    </div>
                    
                    <button class="end-nap-btn" onclick="endActiveNap()">‚èπÔ∏è End Nap</button>
                </div>
            `;
        }

        function updateActiveNapStartTime(newTime) {
            if (!activeNap) return;
            
            const [hours, minutes] = newTime.split(':');
            const newStart = new Date();
            newStart.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            activeNap.startTime = newStart;
            updateActiveNapDisplay();
            updateNextSleepWindow();
        }

        function startActiveNap() {
            if (!selectedLocation) {
                alert('‚ö†Ô∏è Please select where baby is napping first!');
                return;
            }

            activeNap = {
                startTime: new Date(),
                location: selectedLocation
            };

            document.getElementById('manual-nap-entry').style.display = 'none';
            document.getElementById('start-nap-btn').style.display = 'none';
            
            updateActiveNapDisplay();
            updateNapAlert();
            activeNapInterval = setInterval(() => {
                updateActiveNapDisplay();
                updateNapAlert();
            }, 10000);
            updateNextSleepWindow();
        }

        function endActiveNap() {
            if (!activeNap) return;

            const endTime = new Date();
            const start = activeNap.startTime;
            const diff = endTime - start;
            
            const totalMinutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m`;
            } else {
                durationText = `${minutes}m`;
            }

            const isShortNap = totalMinutes < 20;

            const nap = {
                id: Date.now() + Math.random(), // Unique ID
                start: start.toTimeString().slice(0, 5),
                end: endTime.toTimeString().slice(0, 5),
                duration: durationText,
                durationMinutes: totalMinutes,
                location: activeNap.location,
                shortNap: isShortNap
            };

            savedNaps.push(nap);
            
            activeNap = null;
            clearInterval(activeNapInterval);
            
            document.getElementById('manual-nap-entry').style.display = 'block';
            document.getElementById('start-nap-btn').style.display = 'block';
            
            renderSavedNaps();
            updateActiveNapDisplay();
            updateNapAlert();
            clearNapForm();
            updateSummary();
            updateNextSleepWindow();
            saveDailySleepData();
        }

        function updateNextSleepWindow() {
            const wakeTime = document.getElementById('wake-time').value;
            const dob = localStorage.getItem('baby-dob');
            const display = document.getElementById('next-sleep-window-display');

            // Hide sleep window if viewing a past date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const viewingDate = new Date(currentDate + 'T00:00:00');
            viewingDate.setHours(0, 0, 0, 0);
            const isToday = viewingDate.getTime() === today.getTime();

            if (!isToday || !dob) {
                display.innerHTML = '';
                return;
            }

            const age = calculateAge(dob);
            const recommendation = getWakeWindowRecommendation(age.months);
            
            let wakeWindowMinutes = 120;
            if (age.months <= 2) wakeWindowMinutes = 75;
            else if (age.months <= 6) wakeWindowMinutes = 150;
            else if (age.months <= 12) wakeWindowMinutes = 210;
            else wakeWindowMinutes = 270;

            const now = new Date();
            let lastSleepEnd = null;

            // Check if baby went to bed for the night
            const babyInBed = localStorage.getItem(`baby-in-bed-${currentDate}`);
            if (babyInBed) {
                // Get the logged bedtime to display
                const key = `daily-sleep-${currentDate}`;
                const stored = localStorage.getItem(key);
                let bedtimeText = '';
                
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.tonightBedtime) {
                        const bedtimeDate = new Date(data.tonightBedtime);
                        const displayTime = bedtimeDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        bedtimeText = `Bedtime logged at ${displayTime}`;
                    } else {
                        bedtimeText = 'Bedtime logged';
                    }
                } else {
                    bedtimeText = 'Bedtime logged';
                }
                
                display.innerHTML = `
                    <div class="next-sleep-window sleeping">
                        <h3>üò¥ Baby is Sleeping</h3>
                        <div class="next-sleep-time">Good Night üåô</div>
                        <div class="next-sleep-countdown">
                            ${bedtimeText}
                        </div>
                    </div>
                `;
                return;
            }

            if (activeNap) {
                display.innerHTML = `
                    <div class="next-sleep-window sleeping">
                        <h3>üò¥ Baby is Sleeping</h3>
                        <div class="next-sleep-time">Zzz...</div>
                        <div class="next-sleep-countdown">
                            Nap in progress
                        </div>
                    </div>
                `;
                return;
            }

            if (wakeTime) {
                lastSleepEnd = new Date(wakeTime);
            }

            // Check all naps to determine wake window adjustment and time range
            let adjustedWakeWindow = wakeWindowMinutes;
            let adjustmentLabel = '';
            let lastNapForWindow = null;
            let showTimeRange = false;
            let rangeMinutes = 0;
            
            if (savedNaps.length > 0) {
                const lastNap = savedNaps[savedNaps.length - 1];
                const napDuration = lastNap.durationMinutes;
                
                // Under 20 minutes: non-restorative, skip this nap entirely
                if (napDuration < 20) {
                    // Find the last restorative nap (20+ minutes)
                    const restorativeNaps = savedNaps.filter(nap => nap.durationMinutes >= 20);
                    if (restorativeNaps.length > 0) {
                        lastNapForWindow = restorativeNaps[restorativeNaps.length - 1];
                    }
                    // Show wide time range for very short nap
                    showTimeRange = true;
                    rangeMinutes = 45; // ¬±45 min range
                    adjustmentLabel = '‚ö†Ô∏è Short nap - watch for sleepy cues';
                }
                // 20-60 minutes: short to medium nap, use moderate range
                else if (napDuration >= 20 && napDuration < 60) {
                    lastNapForWindow = lastNap;
                    showTimeRange = true;
                    rangeMinutes = 30; // ¬±30 min range
                    adjustmentLabel = '‚ö†Ô∏è Medium nap - timing may vary';
                }
                // 60+ minutes: good restorative nap, tight range or single time
                else {
                    lastNapForWindow = lastNap;
                    showTimeRange = false; // Single time for good naps
                }
            }
            
            // Use the appropriate nap for wake window calculation
            if (lastNapForWindow) {
                const napEndTime = new Date();
                const [hours, minutes] = lastNapForWindow.end.split(':');
                napEndTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (!lastSleepEnd || napEndTime > lastSleepEnd) {
                    lastSleepEnd = napEndTime;
                }
            }

            if (!lastSleepEnd) {
                display.innerHTML = '';
                return;
            }

            const nextSleepTime = new Date(lastSleepEnd.getTime() + adjustedWakeWindow * 60000);
            const timeUntil = nextSleepTime - now;

            // Calculate time range if needed
            let timeRangeStart, timeRangeEnd;
            if (showTimeRange) {
                timeRangeStart = new Date(nextSleepTime.getTime() - rangeMinutes * 60000);
                timeRangeEnd = new Date(nextSleepTime.getTime() + rangeMinutes * 60000);
            }

            // Check if sleep window is after 6:30 PM (18:30)
            const sleepHour = nextSleepTime.getHours();
            const sleepMinute = nextSleepTime.getMinutes();
            const isBedtime = (sleepHour > 18) || (sleepHour === 18 && sleepMinute >= 30);
            const sleepLabel = isBedtime ? 'üåô Bedtime' : '‚è∞ Next Sleep Window';
            const sleepAction = isBedtime ? 'bedtime' : 'next sleep';

            // Check if it's currently after 6:30 PM for bedtime button
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const isAfterBedtime = (currentHour > 18) || (currentHour === 18 && currentMinute >= 30);

            const formatTimeStr = (date) => date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });

            let nextTimeStr;
            if (showTimeRange) {
                nextTimeStr = `${formatTimeStr(timeRangeStart)} - ${formatTimeStr(timeRangeEnd)}`;
            } else {
                nextTimeStr = formatTimeStr(nextSleepTime);
            }

            if (timeUntil < 0) {
                const timeSince = Math.abs(timeUntil);
                const hoursSince = Math.floor(timeSince / (1000 * 60 * 60));
                const minutesSince = Math.floor((timeSince % (1000 * 60 * 60)) / (1000 * 60));
                
                const pastLabel = isBedtime ? 'üåô Bedtime Window Passed' : '‚è∞ Last Sleep Window';
                
                // Show "Baby Asleep" button if it's after 6:30 PM (based on current time)
                const bedtimeButton = isAfterBedtime ? `
                    <button onclick="logBedtime()" style="
                        margin-top: 12px;
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1.1em;
                        font-weight: 600;
                        cursor: pointer;
                        width: 100%;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                    ">
                        üò¥ Baby Asleep - Log Bedtime
                    </button>
                ` : '';
                
                display.innerHTML = `
                    <div class="next-sleep-window passed">
                        <h3>${pastLabel}</h3>
                        <div class="next-sleep-time">${nextTimeStr}</div>
                        <div class="next-sleep-countdown">
                            Was ${hoursSince > 0 ? `${hoursSince}h ` : ''}${minutesSince}m ago
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9em; opacity: 0.9;">
                            Wake window: ${recommendation.windows}
                            ${adjustmentLabel ? `<br>${adjustmentLabel}` : ''}
                        </div>
                        ${bedtimeButton}
                    </div>
                `;
            } else {
                const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
                const minutesUntil = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
                
                // Show bedtime button even if wake window hasn't arrived, if it's after 6:30 PM
                const bedtimeButton = isAfterBedtime ? `
                    <button onclick="logBedtime()" style="
                        margin-top: 12px;
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1.1em;
                        font-weight: 600;
                        cursor: pointer;
                        width: 100%;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                    ">
                        üò¥ Baby Asleep - Log Bedtime
                    </button>
                ` : '';
                
                display.innerHTML = `
                    <div class="next-sleep-window">
                        <h3>${sleepLabel}</h3>
                        <div class="next-sleep-time">${nextTimeStr}</div>
                        <div class="next-sleep-countdown">
                            ${hoursUntil > 0 ? `${hoursUntil}h ` : ''}${minutesUntil}m until ${sleepAction}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9em; opacity: 0.9;">
                            Wake window: ${recommendation.windows}
                            ${adjustmentLabel ? `<br>${adjustmentLabel}` : ''}
                        </div>
                        ${bedtimeButton}
                    </div>
                `;
            }
        }

        function logBedtime() {
            const now = new Date();
            
            // Format current time for display (12-hour)
            const displayTime = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            // Format for input field in local timezone (YYYY-MM-DDTHH:MM)
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            let bedtimeStr = `${year}-${month}-${day}T${hour}:${minute}`;
            
            // Get current time in 12-hour format for default
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            const defaultTime = `${hours}:${minutes} ${ampm}`;
            
            // Ask user to confirm or edit the time
            const userInput = prompt(
                `Log bedtime as ${displayTime}?\n\nEdit if needed (example: 8:30 PM):`,
                defaultTime
            );
            
            if (userInput === null) {
                // User cancelled
                return;
            }
            
            // Parse the user's time input (handles formats like "8:30 PM" or "8:30pm")
            if (userInput) {
                const match = userInput.match(/^(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)$/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const period = match[3].toUpperCase();
                    
                    // Convert to 24-hour format
                    if (period === 'PM' && hours !== 12) hours += 12;
                    if (period === 'AM' && hours === 12) hours = 0;
                    
                    const editedTime = new Date();
                    editedTime.setHours(hours, minutes, 0, 0);
                    
                    // Format in local timezone
                    const year = editedTime.getFullYear();
                    const month = String(editedTime.getMonth() + 1).padStart(2, '0');
                    const day = String(editedTime.getDate()).padStart(2, '0');
                    const hour = String(editedTime.getHours()).padStart(2, '0');
                    const minute = String(editedTime.getMinutes()).padStart(2, '0');
                    bedtimeStr = `${year}-${month}-${day}T${hour}:${minute}`;
                }
            }
            
            // Save to tonight's bedtime field
            document.getElementById('tonight-bedtime').value = bedtimeStr;
            
            // Mark that baby is in bed
            localStorage.setItem(`baby-in-bed-${currentDate}`, 'true');
            
            // Save the data
            saveDailySleepData();
            
            // Update displays
            updateNextSleepWindow();
            updateLoggedBedtimeDisplay();
            
            // Show confirmation with the logged time
            const confirmedTime = new Date(bedtimeStr).toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            alert(`‚úÖ Bedtime logged at ${confirmedTime}! Good night üåô`);
        }

        function updateLoggedBedtimeDisplay() {
            const bedtimeInput = document.getElementById('tonight-bedtime').value;
            const display = document.getElementById('logged-bedtime-display');
            const textDisplay = document.getElementById('logged-bedtime-text');
            
            if (bedtimeInput) {
                const bedtimeDate = new Date(bedtimeInput);
                const displayTime = bedtimeDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                textDisplay.textContent = displayTime;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        function editLoggedBedtime() {
            const bedtimeInput = document.getElementById('tonight-bedtime');
            const currentValue = bedtimeInput.value;
            
            if (!currentValue) return;
            
            const currentTime = new Date(currentValue);
            let hours = currentTime.getHours();
            const minutes = currentTime.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            const defaultTime = `${hours}:${minutes} ${ampm}`;
            
            const userInput = prompt(
                `Edit bedtime:\n\nCurrent: ${defaultTime}\n\nEnter new time:`,
                defaultTime
            );
            
            if (userInput === null) return;
            
            // Parse the user's time input
            if (userInput) {
                const match = userInput.match(/^(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)$/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const period = match[3].toUpperCase();
                    
                    // Convert to 24-hour format
                    if (period === 'PM' && hours !== 12) hours += 12;
                    if (period === 'AM' && hours === 12) hours = 0;
                    
                    const editedTime = new Date();
                    editedTime.setHours(hours, minutes, 0, 0);
                    
                    // Format in local timezone for datetime-local input
                    const year = editedTime.getFullYear();
                    const month = String(editedTime.getMonth() + 1).padStart(2, '0');
                    const day = String(editedTime.getDate()).padStart(2, '0');
                    const hour = String(editedTime.getHours()).padStart(2, '0');
                    const minute = String(editedTime.getMinutes()).padStart(2, '0');
                    bedtimeInput.value = `${year}-${month}-${day}T${hour}:${minute}`;
                    
                    // Save and update
                    saveDailySleepData();
                    updateLoggedBedtimeDisplay();
                    updateNextSleepWindow();
                    
                    alert('‚úÖ Bedtime updated!');
                }
            }
        }

        function updateNapAlert() {
            const display = document.getElementById('nap-alert-display');
            const preferredBedtime = localStorage.getItem('preferred-bedtime');
            
            // Only show alert if we have a preferred bedtime and there's an active nap
            if (!preferredBedtime || !activeNap) {
                display.innerHTML = '';
                return;
            }
            
            const now = new Date();
            const dob = localStorage.getItem('baby-dob');
            
            if (!dob) {
                display.innerHTML = '';
                return;
            }
            
            const age = calculateAge(dob);
            
            // Determine typical nap count by age to know if this is likely the last nap
            let expectedNapCount = 3;
            if (age.months <= 3) expectedNapCount = 4;
            else if (age.months <= 6) expectedNapCount = 3;
            else if (age.months <= 9) expectedNapCount = 2;
            else if (age.months <= 15) expectedNapCount = 2;
            else expectedNapCount = 1;
            
            // Only alert if we're on what might be the last nap (or close to it)
            const currentNapNumber = savedNaps.length + 1; // +1 for the active nap
            if (currentNapNumber < expectedNapCount - 1) {
                // This is an early nap, not the last one - no alert needed
                display.innerHTML = '';
                return;
            }
            
            // Determine wake window before bedtime (typically the longest of the day)
            let bedtimeWakeWindowMinutes = 180; // Default 3 hours
            if (age.months <= 2) bedtimeWakeWindowMinutes = 90;
            else if (age.months <= 4) bedtimeWakeWindowMinutes = 120;
            else if (age.months <= 6) bedtimeWakeWindowMinutes = 150;
            else if (age.months <= 9) bedtimeWakeWindowMinutes = 180;
            else if (age.months <= 12) bedtimeWakeWindowMinutes = 210;
            else bedtimeWakeWindowMinutes = 240;
            
            // Parse bedtime (format is HH:MM)
            const [bedtimeHours, bedtimeMinutes] = preferredBedtime.split(':').map(Number);
            const bedtimeToday = new Date();
            bedtimeToday.setHours(bedtimeHours, bedtimeMinutes, 0, 0);
            
            // Calculate when THIS nap should end to protect bedtime
            const idealNapEndTime = new Date(bedtimeToday.getTime() - bedtimeWakeWindowMinutes * 60000);
            
            // Calculate how long this nap has been going
            const napDuration = now - activeNap.startTime;
            const napMinutes = Math.floor(napDuration / (1000 * 60));
            
            // Project when nap will end if it reaches typical length (90-120 min for older babies, 45-60 for younger)
            let typicalNapMinutes = 60;
            if (age.months >= 4) typicalNapMinutes = 90;
            if (age.months >= 9) typicalNapMinutes = 120;
            
            const projectedNapEnd = new Date(activeNap.startTime.getTime() + typicalNapMinutes * 60000);
            
            // Only alert if the nap WOULD interfere with bedtime if it goes a typical length
            // OR if it's already gone past the ideal end time
            if (now > idealNapEndTime) {
                // Nap has already gone past ideal end time
                const napEndTimeStr = idealNapEndTime.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                const minutesOverdue = Math.floor((now - idealNapEndTime) / (1000 * 60));
                
                display.innerHTML = `
                    <div class="nap-alert">
                        <h3>‚è∞ Wake Baby Alert!</h3>
                        <div class="nap-alert-time">${napEndTimeStr}</div>
                        <div class="nap-alert-message">
                            Nap should have ended ${minutesOverdue} minutes ago to protect bedtime
                        </div>
                    </div>
                `;
            } else if (projectedNapEnd > idealNapEndTime && napMinutes > 30) {
                // Nap is likely to interfere if it goes normal length, and has been going for a bit
                const timeUntilIdealEnd = idealNapEndTime - now;
                const minutesUntil = Math.floor(timeUntilIdealEnd / (1000 * 60));
                
                if (minutesUntil <= 30) {
                    const napEndTimeStr = idealNapEndTime.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    
                    display.innerHTML = `
                        <div class="nap-alert" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <h3>‚ö†Ô∏è Nap Ending Soon</h3>
                            <div class="nap-alert-time">${napEndTimeStr}</div>
                            <div class="nap-alert-message">
                                Consider waking in ${minutesUntil} minutes to protect bedtime
                            </div>
                        </div>
                    `;
                } else {
                    display.innerHTML = '';
                }
            } else {
                display.innerHTML = '';
            }
        }

        function initializeTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            if (tabName === 'history') {
                renderHistoryCalendar();
            } else if (tabName === 'trends') {
                loadTrendsData();
            }
        }

        function setupRadioButtons() {
            document.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    document.querySelectorAll(`input[name="${radio.name}"]`).forEach(r => {
                        r.closest('.radio-option').classList.remove('selected');
                    });
                    this.classList.add('selected');
                    saveDailySleepData();
                    updateSummary();
                });
            });
        }

        function setupLocationButtons() {
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.location-btn').forEach(b => {
                        b.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedLocation = this.getAttribute('data-location');
                });
            });
        }

        function setupNapInputs() {
            document.getElementById('nap-start').addEventListener('input', calculateNapDuration);
            document.getElementById('nap-end').addEventListener('input', calculateNapDuration);
        }

        function calculateNapDuration() {
            const start = document.getElementById('nap-start').value;
            const end = document.getElementById('nap-end').value;
            const display = document.getElementById('nap-duration-display');
            const checkbox = document.getElementById('short-nap-checkbox');

            if (!start || !end) {
                display.innerHTML = '';
                return;
            }

            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            let diff = endTime - startTime;

            if (diff < 0) {
                display.innerHTML = '<div style="color: #ef4444; margin-top: 10px;">‚ö†Ô∏è End time must be after start time</div>';
                return;
            }

            const totalMinutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m`;
            } else {
                durationText = `${minutes}m`;
            }

            // Auto-check short nap if under 45 minutes
            if (totalMinutes < 45) {
                checkbox.checked = true;
                checkbox.closest('.checkbox-option').classList.add('checked');
            } else {
                checkbox.checked = false;
                checkbox.closest('.checkbox-option').classList.remove('checked');
            }

            display.innerHTML = `<div class="nap-duration">üí§ Nap Duration: ${durationText}</div>`;
        }

        function setDefaultDatetimes() {
            const [year, month, day] = currentDate.split('-').map(Number);
            const viewingDate = new Date(year, month - 1, day);
            const dayBefore = new Date(year, month - 1, day - 1);
            
            const formatDate = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            
            const dayBeforeStr = formatDate(dayBefore);
            const viewingDateStr = formatDate(viewingDate);
            
            const bedtimeInput = document.getElementById('bedtime');
            const wakeTimeInput = document.getElementById('wake-time');
            
            // Try to get yesterday's actual bedtime
            if (!bedtimeInput.value) {
                const yesterdayKey = `daily-sleep-${dayBeforeStr}`;
                const yesterdayData = localStorage.getItem(yesterdayKey);
                
                if (yesterdayData) {
                    const data = JSON.parse(yesterdayData);
                    if (data.tonightBedtime) {
                        // Use yesterday's actual bedtime (it's already in full datetime format)
                        bedtimeInput.value = data.tonightBedtime;
                    } else {
                        // Default to 7:30 PM
                        bedtimeInput.value = `${dayBeforeStr}T19:30`;
                    }
                } else {
                    bedtimeInput.value = `${dayBeforeStr}T19:30`;
                }
            }
            
            if (!wakeTimeInput.value) {
                wakeTimeInput.value = `${viewingDateStr}T07:00`;
            }
        }

        function initializeTrackerTab() {
            document.getElementById('prev-date').addEventListener('click', () => changeDate(-1));
            document.getElementById('next-date').addEventListener('click', () => changeDate(1));
            document.getElementById('save-nap-btn').addEventListener('click', saveNap);
            document.getElementById('start-nap-btn').addEventListener('click', startActiveNap);
            document.getElementById('save-wakeup-btn').addEventListener('click', saveWakeup);
            
            ['bedtime', 'wake-time', 'came-to-bed', 'bedtime-routine', 'notes'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    saveDailySleepData();
                    updateSummary();
                    updateNextSleepWindow();
                });
            });
            
            // Tonight's actual bedtime is just for logging
            document.getElementById('tonight-bedtime').addEventListener('input', () => {
                saveDailySleepData();
                updateSummary();
                updateNextSleepWindow();
            });
            
            setupWakeupInputs();
        }
        
        function setupWakeupInputs() {
            document.getElementById('wakeup-start').addEventListener('input', calculateWakeupDuration);
            document.getElementById('wakeup-end').addEventListener('input', calculateWakeupDuration);
        }
        
        function calculateWakeupDuration() {
            const start = document.getElementById('wakeup-start').value;
            const end = document.getElementById('wakeup-end').value;
            const display = document.getElementById('wakeup-duration-display');
            
            if (!start || !end) {
                display.innerHTML = '';
                return;
            }
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            let diff = endTime - startTime;
            
            if (diff < 0) {
                diff += 24 * 60 * 60 * 1000; // Handle crossing midnight
            }
            
            const totalMinutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m`;
            } else {
                durationText = `${minutes}m`;
            }
            
            display.innerHTML = `‚è±Ô∏è Awake for: ${durationText}`;
        }
        
        function saveWakeup() {
            const start = document.getElementById('wakeup-start').value;
            const end = document.getElementById('wakeup-end').value;
            
            if (!start || !end) {
                alert('‚ö†Ô∏è Please enter both wake-up start and end times');
                return;
            }
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            let diff = endTime - startTime;
            
            if (diff < 0) {
                diff += 24 * 60 * 60 * 1000;
            }
            
            const totalMinutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m`;
            } else {
                durationText = `${minutes}m`;
            }
            
            const wakeup = {
                start,
                end,
                duration: durationText,
                durationMinutes: totalMinutes
            };
            
            if (editingWakeupIndex >= 0) {
                savedWakeups[editingWakeupIndex] = wakeup;
                editingWakeupIndex = -1;
            } else {
                savedWakeups.push(wakeup);
            }
            
            renderSavedWakeups();
            clearWakeupForm();
            updateSummary();
            saveDailySleepData();
        }
        
        function renderSavedWakeups() {
            const list = document.getElementById('saved-wakeups-list');
            
            if (savedWakeups.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            function formatTime12Hour(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                let hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12 || 12;
                return `${hour}:${minutes} ${ampm}`;
            }
            
            list.innerHTML = savedWakeups.map((wakeup, index) => {
                return `
                    <div class="saved-nap" style="margin-bottom: 10px;">
                        <div class="saved-nap-info">
                            <h4>üåÉ Wake-up ${index + 1}</h4>
                            <div class="saved-nap-details">
                                <strong>‚è∞ ${formatTime12Hour(wakeup.start)} - ${formatTime12Hour(wakeup.end)}</strong> (${wakeup.duration})
                            </div>
                        </div>
                        <div class="saved-nap-actions">
                            <button class="edit-btn" onclick="editWakeup(${index})">‚úèÔ∏è Edit</button>
                            <button class="delete-btn" onclick="deleteWakeup(${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editWakeup(index) {
            const wakeup = savedWakeups[index];
            document.getElementById('wakeup-start').value = wakeup.start;
            document.getElementById('wakeup-end').value = wakeup.end;
            editingWakeupIndex = index;
            calculateWakeupDuration();
            window.scrollTo({ top: 300, behavior: 'smooth' });
        }
        
        function deleteWakeup(index) {
            if (confirm('Are you sure you want to delete this wake-up?')) {
                savedWakeups.splice(index, 1);
                renderSavedWakeups();
                updateSummary();
                saveDailySleepData();
            }
        }
        
        function clearWakeupForm() {
            document.getElementById('wakeup-start').value = '';
            document.getElementById('wakeup-end').value = '';
            document.getElementById('wakeup-duration-display').innerHTML = '';
            editingWakeupIndex = -1;
        }

        function saveNap() {
            const start = document.getElementById('nap-start').value;
            const end = document.getElementById('nap-end').value;
            
            if (!start || !end) {
                alert('‚ö†Ô∏è Please enter both nap start and end times');
                return;
            }

            if (!selectedLocation) {
                alert('‚ö†Ô∏è Please select where baby napped');
                return;
            }

            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            let diff = endTime - startTime;

            if (diff < 0) {
                alert('‚ö†Ô∏è End time must be after start time');
                return;
            }

            const totalMinutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m`;
            } else {
                durationText = `${minutes}m`;
            }

            // Automatically mark naps under 20 minutes as non-restorative
            const isShortNap = totalMinutes < 20 || document.getElementById('short-nap-checkbox').checked;
            const napNotes = document.getElementById('nap-notes').value;

            const nap = {
                id: Date.now() + Math.random(), // Unique ID
                start,
                end,
                duration: durationText,
                durationMinutes: totalMinutes,
                location: selectedLocation,
                shortNap: isShortNap,
                notes: napNotes
            };

            if (editingNapIndex >= 0) {
                // Preserve the ID when editing
                nap.id = savedNaps[editingNapIndex].id;
                savedNaps[editingNapIndex] = nap;
                editingNapIndex = -1;
            } else {
                savedNaps.push(nap);
            }

            // Sort naps by start time so they always appear chronologically
            savedNaps.sort((a, b) => {
                const timeA = a.start.split(':').map(Number);
                const timeB = b.start.split(':').map(Number);
                const minutesA = timeA[0] * 60 + timeA[1];
                const minutesB = timeB[0] * 60 + timeB[1];
                return minutesA - minutesB;
            });

            renderSavedNaps();
            clearNapForm();
            updateSummary();
            updateNextSleepWindow();
            saveDailySleepData();
        }

        function renderSavedNaps() {
            const list = document.getElementById('saved-naps-list');
            
            if (savedNaps.length === 0) {
                list.innerHTML = '';
                return;
            }

            // Function to convert 24-hour time to 12-hour AM/PM
            function formatTime12Hour(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                let hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12 || 12; // Convert 0 to 12 for midnight
                return `${hour}:${minutes} ${ampm}`;
            }

            list.innerHTML = savedNaps.map((nap, index) => {
                const locationEmoji = {
                    'crib': 'üõèÔ∏è',
                    'stroller': 'üöº',
                    'car': 'üöó',
                    'carrier': 'üë∂',
                    'contact': 'ü§±',
                    'other': 'üìç'
                };
                
                const shortNapClass = nap.shortNap ? 'short-nap' : '';
                const shortNapBadge = nap.shortNap ? '<span class="short-nap-badge">Not Restorative</span>' : '';
                const notesDisplay = nap.notes ? `<br><span style="color: #666; font-size: 0.9em;">üí≠ ${nap.notes}</span>` : '';
                
                return `
                    <div class="saved-nap ${shortNapClass}">
                        <div class="saved-nap-info">
                            <h4>üí§ Nap ${index + 1}${shortNapBadge}</h4>
                            <div class="saved-nap-details">
                                <strong>‚è∞ ${formatTime12Hour(nap.start)} - ${formatTime12Hour(nap.end)}</strong> (${nap.duration})
                                <br>
                                <span>${locationEmoji[nap.location]} ${nap.location}</span>
                                ${notesDisplay}
                            </div>
                        </div>
                        <div class="saved-nap-actions">
                            <button class="edit-btn" data-nap-index="${index}">‚úèÔ∏è Edit</button>
                            <button class="delete-btn" data-nap-index="${index}">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners after HTML is rendered
            document.querySelectorAll('.saved-nap .edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-nap-index'));
                    editNap(index);
                });
            });
            
            document.querySelectorAll('.saved-nap .delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-nap-index'));
                    deleteNap(index);
                });
            });
        }

        function editNap(napIndex) {
            if (napIndex < 0 || napIndex >= savedNaps.length) return;
            
            const nap = savedNaps[napIndex];
            document.getElementById('nap-start').value = nap.start;
            document.getElementById('nap-end').value = nap.end;
            document.getElementById('nap-notes').value = nap.notes || '';
            
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('data-location') === nap.location) {
                    btn.classList.add('selected');
                }
            });
            selectedLocation = nap.location;
            
            const checkbox = document.getElementById('short-nap-checkbox');
            checkbox.checked = nap.shortNap || false;
            if (checkbox.checked) {
                checkbox.closest('.checkbox-option').classList.add('checked');
            } else {
                checkbox.closest('.checkbox-option').classList.remove('checked');
            }
            
            editingNapIndex = napIndex;
            calculateNapDuration();
            
            window.scrollTo({ top: 400, behavior: 'smooth' });
        }

        function deleteNap(napIndex) {
            console.log('Delete clicked for index:', napIndex);
            console.log('Current savedNaps:', savedNaps);
            console.log('Nap to delete:', savedNaps[napIndex]);
            
            if (confirm('Are you sure you want to delete this nap?')) {
                if (napIndex >= 0 && napIndex < savedNaps.length) {
                    console.log('Deleting nap at index', napIndex);
                    savedNaps.splice(napIndex, 1);
                    console.log('After delete, savedNaps:', savedNaps);
                    renderSavedNaps();
                    updateSummary();
                    updateNextSleepWindow();
                    saveDailySleepData();
                } else {
                    console.log('Invalid index:', napIndex, 'Array length:', savedNaps.length);
                }
            }
        }

        function clearNapForm() {
            document.getElementById('nap-start').value = '';
            document.getElementById('nap-end').value = '';
            document.getElementById('nap-notes').value = '';
            document.getElementById('nap-duration-display').innerHTML = '';
            document.getElementById('short-nap-checkbox').checked = false;
            document.getElementById('short-nap-checkbox').closest('.checkbox-option').classList.remove('checked');
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            selectedLocation = '';
            editingNapIndex = -1;
        }

        function changeDate(days) {
            const [year, month, day] = currentDate.split('-').map(Number);
            const date = new Date(year, month - 1, day); // Create date in local timezone
            date.setDate(date.getDate() + days);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            if (date > today) {
                return;
            }
            
            // Format as YYYY-MM-DD in local timezone
            const newYear = date.getFullYear();
            const newMonth = String(date.getMonth() + 1).padStart(2, '0');
            const newDay = String(date.getDate()).padStart(2, '0');
            currentDate = `${newYear}-${newMonth}-${newDay}`;
            
            savedNaps = [];
            updateDateDisplay();
            loadDailySleepData();
            updateNextSleepWindow();
            
            if (currentTab === 'history') {
                loadHistoryEntries();
                updateHistoryDateDisplay();
            }
        }

        function updateDateDisplay() {
            const [year, month, day] = currentDate.split('-').map(Number);
            const date = new Date(year, month - 1, day); // Create date in local timezone
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            const isToday = date.getTime() === today.getTime();
            
            const formatted = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            const displayHTML = isToday ? 
                `${formatted} <span class="today-badge">TODAY</span>` : 
                formatted;
            
            document.getElementById('current-date-display').innerHTML = displayHTML;
            document.getElementById('next-date').disabled = isToday;
        }

        function calculateAge(dob) {
            if (!dob) return null;
            const birthDate = new Date(dob);
            const today = new Date();
            
            // Calculate months by comparing year and month
            let months = (today.getFullYear() - birthDate.getFullYear()) * 12;
            months += today.getMonth() - birthDate.getMonth();
            
            // If we haven't reached the birth day this month yet, subtract one month
            if (today.getDate() < birthDate.getDate()) {
                months--;
            }
            
            // Calculate weeks within the current month
            const lastMonthBirthday = new Date(today.getFullYear(), today.getMonth(), birthDate.getDate());
            if (today.getDate() < birthDate.getDate()) {
                // Go back one month
                lastMonthBirthday.setMonth(lastMonthBirthday.getMonth() - 1);
            }
            
            const daysSinceLastMonthBirthday = Math.floor((today - lastMonthBirthday) / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(daysSinceLastMonthBirthday / 7);
            
            const ageInDays = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24));
            
            return { months, weeks, days: ageInDays };
        }

        function updateBabyDisplay() {
            const name = localStorage.getItem('baby-name') || 'Baby';
            const dob = localStorage.getItem('baby-dob');
            
            document.getElementById('baby-display-name').textContent = name;
            
            if (dob) {
                const age = calculateAge(dob);
                document.getElementById('baby-display-age').textContent = 
                    `${age.months} month${age.months !== 1 ? 's' : ''}, ${age.weeks} week${age.weeks !== 1 ? 's' : ''} old`;
                
                const recommendation = getWakeWindowRecommendation(age.months);
                document.getElementById('setup-section').innerHTML = `
                    <div class="wake-window-info">
                        <h4>üí° Age-Based Sleep Guidelines for ${name}</h4>
                        <p><strong>Wake Windows:</strong> ${recommendation.windows}</p>
                        <p><strong>Typical Naps:</strong> ${recommendation.naps}</p>
                    </div>
                `;
                
                document.getElementById('planner-setup-section').innerHTML = `
                    <div class="wake-window-info">
                        <h4>üí° Sleep Guidelines for ${name} (${age.months} months, ${age.weeks} weeks)</h4>
                        <p><strong>Wake Windows:</strong> ${recommendation.windows}</p>
                        <p><strong>Typical Naps:</strong> ${recommendation.naps}</p>
                    </div>
                `;
            } else {
                document.getElementById('baby-display-age').textContent = 'Set up baby info';
                showSetupPrompt();
            }
        }

        function showSetupPrompt() {
            const setupHTML = `
                <div class="setup-prompt">
                    <h3>üëã Welcome! Let's set up your baby's info</h3>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>Baby's Name</label>
                            <input type="text" id="setup-name" placeholder="Enter baby's name">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="setup-dob">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>üåô Preferred Bedtime (for nap planning)</label>
                        <input type="time" id="setup-bedtime" placeholder="e.g., 7:30 PM">
                    </div>
                    <button class="primary-btn" onclick="saveBabyInfo()" style="margin-top: 15px;">Save Baby Info</button>
                </div>
            `;
            document.getElementById('setup-section').innerHTML = setupHTML;
            document.getElementById('planner-setup-section').innerHTML = setupHTML.replace(/setup-/g, 'planner-setup-');
        }

        function saveBabyInfo() {
            const name = document.getElementById('setup-name')?.value || document.getElementById('planner-setup-name')?.value;
            const dob = document.getElementById('setup-dob')?.value || document.getElementById('planner-setup-dob')?.value;
            const bedtime = document.getElementById('setup-bedtime')?.value || document.getElementById('planner-setup-bedtime')?.value;
            
            if (name && dob) {
                localStorage.setItem('baby-name', name);
                localStorage.setItem('baby-dob', dob);
                if (bedtime) {
                    localStorage.setItem('preferred-bedtime', bedtime);
                }
                updateBabyDisplay();
                updateNextSleepWindow();
                updateNapAlert();
                alert(`‚úÖ ${name}'s info saved!`);
            } else {
                alert('Please enter both name and date of birth');
            }
        }

        function loadBabyInfo() {
            updateBabyDisplay();
        }

        function getWakeWindowRecommendation(ageMonths) {
            const recommendations = {
                0: { windows: '45-60 min', naps: '4-6 naps' },
                1: { windows: '60-90 min', naps: '4-5 naps' },
                2: { windows: '75-90 min', naps: '4-5 naps' },
                3: { windows: '90-120 min', naps: '3-4 naps' },
                4: { windows: '2-2.5 hours', naps: '3 naps' },
                5: { windows: '2-2.5 hours', naps: '3 naps' },
                6: { windows: '2.5-3 hours', naps: '2-3 naps' },
                7: { windows: '2.5-3.5 hours', naps: '2 naps' },
                8: { windows: '3-4 hours', naps: '2 naps' },
                9: { windows: '3-4 hours', naps: '2 naps' },
                10: { windows: '3-4 hours', naps: '2 naps' },
                11: { windows: '3-4 hours', naps: '2 naps' },
                12: { windows: '4-5 hours', naps: '1-2 naps' }
            };
            return recommendations[ageMonths] || { windows: '4-5 hours', naps: '1-2 naps' };
        }

        function updateSummary() {
            const bedtime = document.getElementById('bedtime').value;
            const wakeTime = document.getElementById('wake-time').value;
            const summaryDiv = document.getElementById('summary-bar');

            if (!bedtime && !wakeTime) {
                summaryDiv.innerHTML = '';
                return;
            }

            let totalSleep = 0;
            let sleepHours = 0;
            let sleepMinutes = 0;
            let quality = 'good';

            if (bedtime && wakeTime) {
                const bed = new Date(bedtime);
                const wake = new Date(wakeTime);
                let diff = wake - bed;
                if (diff < 0) diff += 24 * 60 * 60 * 1000;
                
                // Calculate total wake-up time
                let totalWakeupMinutes = 0;
                savedWakeups.forEach(wakeup => {
                    totalWakeupMinutes += wakeup.durationMinutes;
                });
                
                // Subtract wake-up time from total sleep
                const totalMinutesInBed = Math.floor(diff / (1000 * 60));
                const actualSleepMinutes = totalMinutesInBed - totalWakeupMinutes;
                
                sleepHours = Math.floor(actualSleepMinutes / 60);
                sleepMinutes = actualSleepMinutes % 60;
                totalSleep = sleepHours + sleepMinutes / 60;

                const dob = localStorage.getItem('baby-dob');
                if (dob) {
                    const age = calculateAge(dob);
                    if (age.months < 4 && totalSleep < 9) quality = 'poor';
                    else if (age.months >= 4 && age.months < 12 && totalSleep < 10) quality = 'poor';
                    else if (age.months >= 12 && totalSleep < 11) quality = 'poor';
                }
            }

            const wakeUpCount = savedWakeups.length;
            if (wakeUpCount > 3) quality = 'poor';

            const napCount = savedNaps.length + (activeNap ? 1 : 0);

            const emoji = quality === 'good' ? 'üåü' : 'üò¥';
            const qualityText = quality === 'good' ? 'Great Sleep!' : 'Needs Rest';

            summaryDiv.innerHTML = `
                <div class="summary-bar ${quality}">
                    <div class="summary-bar-content">
                        <div class="summary-title">${emoji} ${qualityText}</div>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-value">${sleepHours}h ${sleepMinutes}m</span>
                                <span class="stat-label">Night Sleep</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${wakeUpCount}</span>
                                <span class="stat-label">Wake-ups</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${napCount}</span>
                                <span class="stat-label">Naps</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializePlannerTab() {
            document.getElementById('event-type').addEventListener('change', function() {
                const eventDetails = document.getElementById('event-details');
                const eventTimeLabel = document.getElementById('event-time-label');
                
                if (this.value) {
                    eventDetails.style.display = 'block';
                    
                    // Update label based on event type
                    if (this.value === 'appointment') {
                        eventTimeLabel.textContent = '‚è∞ Appointment Time';
                    } else if (this.value === 'dinner') {
                        eventTimeLabel.textContent = '‚è∞ Leave Time';
                    } else if (this.value === 'errand') {
                        eventTimeLabel.textContent = '‚è∞ Errand Start Time';
                    }
                } else {
                    eventDetails.style.display = 'none';
                }
            });
        }

        function calculateNapPlan() {
            const eventType = document.getElementById('event-type').value;
            const eventTime = document.getElementById('event-time').value;
            const eventDuration = parseInt(document.getElementById('event-duration').value) || 60;
            const eventDescription = document.getElementById('event-description').value;
            const resultsDiv = document.getElementById('nap-plan-results');
            
            if (!eventType || !eventTime) {
                alert('Please select an event type and time');
                return;
            }
            
            const dob = localStorage.getItem('baby-dob');
            if (!dob) {
                alert('Please set up baby info first');
                return;
            }
            
            const age = calculateAge(dob);
            
            // Calculate average nap length from logged data
            const avgNapLength = calculateAverageNapLength();
            
            // Parse event time
            const [eventHours, eventMinutes] = eventTime.split(':').map(Number);
            const eventDateTime = new Date();
            eventDateTime.setHours(eventHours, eventMinutes, 0, 0);
            
            let napStartTime, routineStartTime, napEndTime, warnings = [];
            const routineMinutes = 25; // Time for nap routine
            
            if (eventType === 'appointment' || eventType === 'errand') {
                // Baby needs to be asleep DURING the event
                // Nap should start before event, accounting for routine time
                routineStartTime = new Date(eventDateTime.getTime() - routineMinutes * 60000);
                napStartTime = new Date(eventDateTime);
                napEndTime = new Date(napStartTime.getTime() + avgNapLength * 60000);
                
                // Check if nap will last through the event
                const eventEndTime = new Date(eventDateTime.getTime() + eventDuration * 60000);
                if (napEndTime < eventEndTime) {
                    const shortfall = Math.round((eventEndTime - napEndTime) / 60000);
                    warnings.push(`‚ö†Ô∏è Baby's average nap (${avgNapLength} min) may not cover the full ${eventDuration} min event. Baby might wake ${shortfall} minutes before event ends.`);
                }
            } else if (eventType === 'dinner') {
                // Baby needs to be asleep BEFORE you leave
                // Nap end time should be before or at event time
                napEndTime = new Date(eventDateTime);
                napStartTime = new Date(napEndTime.getTime() - avgNapLength * 60000);
                routineStartTime = new Date(napStartTime.getTime() - routineMinutes * 60000);
            }
            
            // Check wake window timing
            const now = new Date();
            const lastSleepEnd = getLastSleepTime();
            
            if (lastSleepEnd) {
                const timeSinceLastSleep = (routineStartTime - lastSleepEnd) / 60000;
                let idealWakeWindow = 180;
                if (age.months <= 2) idealWakeWindow = 75;
                else if (age.months <= 4) idealWakeWindow = 120;
                else if (age.months <= 6) idealWakeWindow = 150;
                else if (age.months <= 9) idealWakeWindow = 180;
                else if (age.months <= 12) idealWakeWindow = 210;
                else idealWakeWindow = 240;
                
                const lowerBound = idealWakeWindow * 0.8;
                const upperBound = idealWakeWindow * 1.2;
                
                if (timeSinceLastSleep < lowerBound) {
                    warnings.push(`‚ö†Ô∏è This timing might be too early. Only ${Math.round(timeSinceLastSleep)} minutes since last sleep (ideal: ${idealWakeWindow} min).`);
                } else if (timeSinceLastSleep > upperBound) {
                    warnings.push(`‚ö†Ô∏è This might be pushing it. ${Math.round(timeSinceLastSleep)} minutes since last sleep (ideal: ${idealWakeWindow} min).`);
                } else {
                    warnings.push(`‚úÖ Perfect timing! ${Math.round(timeSinceLastSleep)} minutes aligns well with wake window.`);
                }
            }
            
            // Format times for display
            const formatTime = (date) => date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            let statusClass = warnings.some(w => w.includes('‚úÖ')) && !warnings.some(w => w.includes('‚ö†Ô∏è')) ? 'good' : 'warning';
            
            resultsDiv.innerHTML = `
                <div class="card" style="margin-top: 20px; border: 3px solid ${statusClass === 'good' ? '#10b981' : '#f59e0b'};">
                    <div class="card-header" style="background: ${statusClass === 'good' ? '#10b981' : '#f59e0b'}; color: white;">
                        üìã Nap Plan ${eventDescription ? `for ${eventDescription}` : ''}
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">‚è∞ Timing Breakdown</h3>
                            <div style="font-size: 1.1em; line-height: 2;">
                                <strong>üéØ Start Routine:</strong> ${formatTime(routineStartTime)}<br>
                                <strong>üí§ Target Nap Start:</strong> ${formatTime(napStartTime)}<br>
                                <strong>‚è±Ô∏è Expected Nap End:</strong> ${formatTime(napEndTime)} <span style="color: #666;">(~${avgNapLength} min based on averages)</span><br>
                                <strong>${eventType === 'appointment' ? 'üè•' : eventType === 'dinner' ? 'üçΩÔ∏è' : 'üõí'} Event:</strong> ${formatTime(eventDateTime)}${eventType !== 'dinner' ? ` - ${formatTime(new Date(eventDateTime.getTime() + eventDuration * 60000))}` : ''}
                            </div>
                        </div>
                        
                        <div style="background: ${statusClass === 'good' ? '#d1fae5' : '#fef3c7'}; padding: 15px; border-radius: 10px; border-left: 4px solid ${statusClass === 'good' ? '#10b981' : '#f59e0b'};">
                            ${warnings.map(w => `<div style="margin: 8px 0;">${w}</div>`).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #667eea; color: white; border-radius: 10px; text-align: center;">
                            <h3 style="margin-bottom: 10px;">üéØ Action Plan</h3>
                            <div style="font-size: 1.2em; font-weight: bold;">Start nap routine at ${formatTime(routineStartTime)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function calculateAverageNapLength() {
            // Get naps from the last 7 days
            let totalMinutes = 0;
            let napCount = 0;
            
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const key = `daily-sleep-${dateStr}`;
                const stored = localStorage.getItem(key);
                
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.naps) {
                        data.naps.forEach(nap => {
                            // Only count restorative naps (20+ minutes)
                            if (nap.durationMinutes >= 20) {
                                totalMinutes += nap.durationMinutes;
                                napCount++;
                            }
                        });
                    }
                }
            }
            
            // Default to age-based average if no data
            if (napCount === 0) {
                const dob = localStorage.getItem('baby-dob');
                if (dob) {
                    const age = calculateAge(dob);
                    if (age.months <= 3) return 45;
                    if (age.months <= 6) return 60;
                    if (age.months <= 12) return 90;
                    return 120;
                }
                return 90; // Default
            }
            
            return Math.round(totalMinutes / napCount);
        }
        
        function getLastSleepTime() {
            // Check today's data for last nap or wake time
            const key = `daily-sleep-${currentDate}`;
            const stored = localStorage.getItem(key);
            
            if (stored) {
                const data = JSON.parse(stored);
                
                // Check for active nap
                if (activeNap) {
                    return null; // Can't plan if baby is currently napping
                }
                
                // Check saved naps
                if (data.naps && data.naps.length > 0) {
                    const lastNap = data.naps[data.naps.length - 1];
                    const napEnd = new Date();
                    const [hours, minutes] = lastNap.end.split(':');
                    napEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    return napEnd;
                }
                
                // Check wake time
                if (data.wakeTime) {
                    return new Date(data.wakeTime);
                }
            }
            
            return null;
        }

        // Removed old history navigation - now using calendar view

        function updateHistoryDateDisplay() {
            const date = new Date(currentDate + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            const isToday = date.getTime() === today.getTime();
            
            const formatted = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            const displayHTML = isToday ? 
                `${formatted} <span class="today-badge">TODAY</span>` : 
                formatted;
            
            document.getElementById('history-date-display').innerHTML = displayHTML;
            document.getElementById('history-next-date').disabled = isToday;
        }

        function formatDateTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function loadHistoryEntries() {
            const key = `daily-sleep-${currentDate}`;
            const stored = localStorage.getItem(key);
            const historyDiv = document.getElementById('history-entries');

            if (!stored) {
                historyDiv.innerHTML = '<div class="no-entries">üò¥ No sleep entries for this date</div>';
                return;
            }

            const entry = JSON.parse(stored);
            const locationEmoji = {
                'crib': 'üõèÔ∏è',
                'stroller': 'üöº',
                'car': 'üöó',
                'carrier': 'üë∂',
                'contact': 'ü§±',
                'other': 'üìç'
            };

            let napsHTML = '';
            if (entry.naps && entry.naps.length > 0) {
                napsHTML = entry.naps.map((nap, i) => {
                    const shortNapText = nap.shortNap ? ' <span class="short-nap-badge">Not Restorative</span>' : '';
                    const napNotesText = nap.notes ? `<br><span style="color: #666;">üí≠ ${nap.notes}</span>` : '';
                    return `<div class="entry-detail">
                        <strong>üí§ Nap ${i + 1}${shortNapText}</strong>
                        ${nap.start} - ${nap.end} (${nap.duration})
                        <br>${locationEmoji[nap.location]} ${nap.location}
                        ${napNotesText}
                    </div>`;
                }).join('');
            }
            
            let wakeupsHTML = '';
            if (entry.wakeups && entry.wakeups.length > 0) {
                wakeupsHTML = entry.wakeups.map((wakeup, i) => {
                    return `<div class="entry-detail">
                        <strong>üåÉ Wake-up ${i + 1}</strong>
                        ${wakeup.start} - ${wakeup.end} (${wakeup.duration})
                    </div>`;
                }).join('');
            }
            
            // Combine bedtime and wake time into one display
            let nightSleepHTML = '';
            if (entry.bedtime && entry.wakeTime) {
                const bedtimeFormatted = formatDateTime(entry.bedtime);
                const wakeTimeFormatted = formatDateTime(entry.wakeTime);
                nightSleepHTML = `<div class="entry-detail"><strong>üåô Night Sleep</strong>${bedtimeFormatted} - ${wakeTimeFormatted}</div>`;
            } else if (entry.bedtime) {
                nightSleepHTML = `<div class="entry-detail"><strong>üåÉ Bedtime</strong>${formatDateTime(entry.bedtime)}</div>`;
            } else if (entry.wakeTime) {
                nightSleepHTML = `<div class="entry-detail"><strong>‚òÄÔ∏è Wake Time</strong>${formatDateTime(entry.wakeTime)}</div>`;
            }

            historyDiv.innerHTML = `
                <div class="sleep-entry">
                    <h4>üí§ Sleep Entry</h4>
                    <div class="entry-details">
                        ${entry.tonightBedtime ? `<div class="entry-detail"><strong>üåô Tonight's Bedtime</strong>${entry.tonightBedtime}</div>` : ''}
                        ${nightSleepHTML}
                        ${entry.bath ? `<div class="entry-detail"><strong>üõÅ Bath</strong>${entry.bath === 'yes' ? 'Yes!' : 'No bath'}</div>` : ''}
                        ${entry.transferred ? `<div class="entry-detail"><strong>üõèÔ∏è Transferred</strong>${entry.transferred === 'awake' ? 'Awake üëÄ' : 'Asleep üò¥'}</div>` : ''}
                        ${wakeupsHTML}
                        ${entry.cameToBed ? `<div class="entry-detail"><strong>üõèÔ∏è Came to Mom & Dad's Bed</strong>${entry.cameToBed}</div>` : ''}
                        ${napsHTML}
                        ${entry.bedtimeRoutine ? `<div class="entry-detail"><strong>üéµ Routine</strong>${entry.bedtimeRoutine}</div>` : ''}
                        ${entry.notes ? `<div class="entry-detail" style="grid-column: 1 / -1"><strong>üí≠ Notes</strong>${entry.notes}</div>` : ''}
                    </div>
                </div>
            `;
        }

        let historyViewMonth = new Date();
        let selectedHistoryDate = null;

        function changeHistoryMonth(direction) {
            historyViewMonth.setMonth(historyViewMonth.getMonth() + direction);
            renderHistoryCalendar();
        }

        function renderHistoryCalendar() {
            const monthDisplay = document.getElementById('history-month-display');
            const calendarDiv = document.getElementById('history-calendar');
            
            monthDisplay.textContent = historyViewMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const year = historyViewMonth.getFullYear();
            const month = historyViewMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            const daysInMonth = lastDay.getDate();
            
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; padding: 8px;">';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: bold; color: #667eea; padding: 5px 0; font-size: 0.75em;">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            // Calendar days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.getTime() === today.getTime();
                const isFuture = date > today;
                
                // Get sleep data
                const key = `daily-sleep-${dateStr}`;
                const stored = localStorage.getItem(key);
                let totalHours = 0;
                let hasData = false;
                
                if (stored && !isFuture) {
                    hasData = true;
                    const data = JSON.parse(stored);
                    
                    // Calculate total sleep
                    if (data.bedtime && data.wakeTime) {
                        const bedtime = new Date(data.bedtime);
                        const wakeTime = new Date(data.wakeTime);
                        let diff = wakeTime - bedtime;
                        if (diff < 0) diff += 24 * 60 * 60 * 1000;
                        totalHours += diff / (1000 * 60 * 60);
                        
                        // Subtract wake-ups
                        if (data.wakeups) {
                            data.wakeups.forEach(w => {
                                if (w.durationMinutes) totalHours -= w.durationMinutes / 60;
                            });
                        }
                    }
                    
                    // Add naps
                    if (data.naps) {
                        data.naps.forEach(nap => {
                            if (nap.durationMinutes) totalHours += nap.durationMinutes / 60;
                        });
                    }
                }
                
                // Color based on sleep amount
                let bgColor = '#f5f5f5';
                let textColor = '#999';
                if (hasData) {
                    if (totalHours >= 12) {
                        bgColor = '#d1fae5'; // Good sleep - green
                        textColor = '#065f46';
                    } else if (totalHours >= 10) {
                        bgColor = '#fef3c7'; // OK sleep - yellow
                        textColor = '#92400e';
                    } else {
                        bgColor = '#fee2e2'; // Low sleep - red
                        textColor = '#991b1b';
                    }
                }
                
                const todayBorder = isToday ? 'border: 2px solid #667eea;' : '';
                const cursor = (hasData || isToday) ? 'cursor: pointer;' : '';
                const opacity = isFuture ? 'opacity: 0.3;' : '';
                
                html += `
                    <div onclick="${!isFuture ? `showHistoryDay('${dateStr}')` : ''}" style="
                        aspect-ratio: 1;
                        background: ${bgColor};
                        border-radius: 6px;
                        padding: 4px;
                        text-align: center;
                        ${todayBorder}
                        ${cursor}
                        ${opacity}
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        min-width: 0;
                    ">
                        <div style="font-weight: bold; font-size: 0.95em; color: ${textColor};">${day}</div>
                        ${hasData ? `<div style="font-size: 0.65em; color: ${textColor}; margin-top: 2px;">${totalHours.toFixed(1)}h</div>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            calendarDiv.innerHTML = html;
        }

        function showHistoryDay(dateStr) {
            selectedHistoryDate = dateStr;
            currentDate = dateStr; // Update global for edit functionality
            
            const date = new Date(dateStr + 'T00:00:00');
            document.getElementById('history-detail-date').textContent = 
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            document.getElementById('history-day-detail').style.display = 'block';
            loadHistoryEntries();
            
            // Scroll to detail
            document.getElementById('history-day-detail').scrollIntoView({ behavior: 'smooth' });
        }

        function closeHistoryDetail() {
            document.getElementById('history-day-detail').style.display = 'none';
        }

        function editHistoryDate() {
            // Switch to tracker tab and keep the current history date
            switchTab('tracker');
            updateDateDisplay();
            loadDailySleepData();
            updateNextSleepWindow();
        }

        let sleepChart = null;

        function loadTrendsData() {
            const today = new Date();
            const dates = [];
            const nightSleepData = [];
            const napData = [];
            const wakeupData = [];
            
            // Get last 7 days of data
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const key = `daily-sleep-${dateStr}`;
                const stored = localStorage.getItem(key);
                
                const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dates.push(dateLabel);
                
                if (stored) {
                    const data = JSON.parse(stored);
                    
                    // Calculate night sleep
                    let nightSleepMinutes = 0;
                    if (data.bedtime && data.wakeTime) {
                        const bed = new Date(data.bedtime);
                        const wake = new Date(data.wakeTime);
                        let diff = wake - bed;
                        if (diff < 0) diff += 24 * 60 * 60 * 1000;
                        nightSleepMinutes = Math.floor(diff / (1000 * 60));
                        
                        // Subtract wake-up time
                        if (data.wakeups) {
                            data.wakeups.forEach(wakeup => {
                                nightSleepMinutes -= wakeup.durationMinutes;
                            });
                        }
                    }
                    nightSleepData.push((nightSleepMinutes / 60).toFixed(1));
                    
                    // Calculate total nap time
                    let napMinutes = 0;
                    if (data.naps) {
                        data.naps.forEach(nap => {
                            napMinutes += nap.durationMinutes;
                        });
                    }
                    napData.push((napMinutes / 60).toFixed(1));
                    
                    // Count wake-ups
                    wakeupData.push(data.wakeups ? data.wakeups.length : 0);
                } else {
                    nightSleepData.push(0);
                    napData.push(0);
                    wakeupData.push(0);
                }
            }
            
            createSleepChart(dates, nightSleepData, napData, wakeupData);
            displaySleepStats(nightSleepData, napData, wakeupData);
            
            try {
                renderWeeklySchedule();
            } catch (error) {
                console.error('Weekly schedule error:', error);
                // Don't break the app if weekly schedule fails
            }
        }

        function createSleepChart(dates, nightSleepData, napData, wakeupData) {
            const ctx = document.getElementById('sleep-chart');
            
            // Destroy existing chart if it exists
            if (sleepChart) {
                sleepChart.destroy();
            }
            
            sleepChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Night Sleep (hours)',
                            data: nightSleepData,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Naps (hours)',
                            data: napData,
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours of Sleep'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function displaySleepStats(nightSleepData, napData, wakeupData) {
            const statsDiv = document.getElementById('sleep-stats');
            
            // Calculate averages
            const validNightSleep = nightSleepData.filter(val => val > 0);
            const validNaps = napData.filter(val => val > 0);
            const validWakeups = wakeupData.filter(val => val >= 0);
            
            const avgNightSleep = validNightSleep.length > 0 
                ? (validNightSleep.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / validNightSleep.length).toFixed(1)
                : 0;
            const avgNaps = validNaps.length > 0
                ? (validNaps.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / validNaps.length).toFixed(1)
                : 0;
            const avgWakeups = validWakeups.length > 0
                ? (validWakeups.reduce((a, b) => parseInt(a) + parseInt(b), 0) / validWakeups.length).toFixed(1)
                : 0;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding: 15px;">
                    <div style="text-align: center; padding: 20px; background: #f0f4ff; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${avgNightSleep}h</div>
                        <div style="color: #666; margin-top: 5px;">Avg Night Sleep</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f0f4ff; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #764ba2;">${avgNaps}h</div>
                        <div style="color: #666; margin-top: 5px;">Avg Nap Time</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f0f4ff; border-radius: 10px;">
                        <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${avgWakeups}</div>
                        <div style="color: #666; margin-top: 5px;">Avg Wake-ups</div>
                    </div>
                </div>
            `;
        }

        let currentWeekOffset = 0;

        function changeWeek(direction) {
            currentWeekOffset += direction;
            renderWeeklySchedule();
        }

        function renderWeeklySchedule() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7)); // Start on Sunday
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                weekDates.push(date);
            }
            
            // Update week display
            const weekDisplay = document.getElementById('week-display');
            const startStr = weekDates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = weekDates[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            weekDisplay.textContent = `${startStr} - ${endStr}`;
            
            // Build the visual schedule with time labels on left
            const scheduleDiv = document.getElementById('weekly-schedule');
            let html = '<div style="display: flex; gap: 0;">';
            
            // Time labels on left (Y-axis)
            html += '<div style="width: 60px; margin-right: 10px;">';
            html += '<div style="height: 40px;"></div>'; // Spacer for day headers
            html += '<div style="position: relative; height: 600px;">';
            for (let hour = 0; hour <= 24; hour += 3) {
                const topPercent = (hour / 24) * 100;
                const label = hour === 0 || hour === 24 ? '12 AM' : hour === 12 ? '12 PM' : hour < 12 ? `${hour} AM` : `${hour - 12} PM`;
                html += `<div style="position: absolute; top: ${topPercent}%; transform: translateY(-50%); font-size: 0.7em; color: #666; text-align: right; width: 50px;">${label}</div>`;
            }
            html += '</div>';
            html += '</div>';
            
            // Day columns
            html += '<div style="display: flex; gap: 8px; flex: 1; overflow-x: auto; -webkit-overflow-scrolling: touch;">';
            
            weekDates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayData = getSleepDataForDate(dateStr);
                
                // Check if this date is in the future
                const now = new Date();
                const dateEnd = new Date(date);
                dateEnd.setHours(23, 59, 59, 999); // End of this day
                const isCompletePast = dateEnd < now; // Entire day is in the past
                const isToday = dateStr === now.toISOString().split('T')[0];
                
                html += `<div style="flex: 1; min-width: 90px;">`;
                html += `<div style="text-align: center; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; height: 40px;">`;
                html += `${date.toLocaleDateString('en-US', { weekday: 'short' })}<br>${date.getDate()}`;
                html += `</div>`;
                
                // Draw the 24-hour column with gridlines
                html += `<div style="position: relative; height: 600px; background: white; border: 1px solid #ddd; border-radius: 8px;">`;
                
                // Add horizontal gridlines every 3 hours
                for (let hour = 0; hour <= 24; hour += 3) {
                    const topPercent = (hour / 24) * 100;
                    html += `<div style="position: absolute; top: ${topPercent}%; left: 0; right: 0; height: 1px; background: #e0e0e0;"></div>`;
                }
                
                // Only show sleep data if date is today or in the past
                if ((isToday || isCompletePast) && dayData) {
                    const currentHour = now.getHours();
                    const currentMinutes = now.getMinutes();
                    const currentTimeInMinutes = currentHour * 60 + currentMinutes;
                    
                    // Add night sleep blocks
                    if (dayData.bedtime && dayData.wakeTime) {
                        const blocks = calculateSleepBlocks(dayData, dateStr);
                        blocks.forEach(block => {
                            // For today, only show blocks that have already occurred
                            if (isToday) {
                                // Calculate block start time in minutes from midnight
                                const blockStartMinutes = (block.top / 100) * (24 * 60);
                                // Only show if block started in the past
                                if (blockStartMinutes <= currentTimeInMinutes) {
                                    html += createSleepBlock(block);
                                }
                            } else {
                                html += createSleepBlock(block);
                            }
                        });
                    }
                    
                    // Add wake-up blocks (gaps in night sleep)
                    if (dayData.wakeups && dayData.wakeups.length > 0) {
                        dayData.wakeups.forEach(wakeup => {
                            const wakeBlock = calculateWakeupBlock(wakeup);
                            if (wakeBlock) {
                                if (isToday) {
                                    const blockStartMinutes = (wakeBlock.top / 100) * (24 * 60);
                                    if (blockStartMinutes <= currentTimeInMinutes) {
                                        html += createWakeupBlock(wakeBlock);
                                    }
                                } else {
                                    html += createWakeupBlock(wakeBlock);
                                }
                            }
                        });
                    }
                    
                    // Add nap blocks
                    if (dayData.naps && dayData.naps.length > 0) {
                        dayData.naps.forEach(nap => {
                            const napBlock = calculateNapBlock(nap, dateStr);
                            if (napBlock) {
                                if (isToday) {
                                    const blockStartMinutes = (napBlock.top / 100) * (24 * 60);
                                    if (blockStartMinutes <= currentTimeInMinutes) {
                                        html += createSleepBlock(napBlock);
                                    }
                                } else {
                                    html += createSleepBlock(napBlock);
                                }
                            }
                        });
                    }
                }
                
                html += `</div>`;
                
                // Total sleep hours - only for past/today
                const totalHours = (isToday || isCompletePast) ? calculateTotalSleep(dayData) : '0.0';
                html += `<div style="text-align: center; margin-top: 5px; font-size: 0.85em; color: #666;">`;
                html += `${totalHours}h`;
                html += `</div>`;
                
                html += `</div>`;
            });
            
            html += '</div></div>';
            
            scheduleDiv.innerHTML = html;
        }

        function getSleepDataForDate(dateStr) {
            const key = `daily-sleep-${dateStr}`;
            const stored = localStorage.getItem(key);
            if (!stored) return null;
            return JSON.parse(stored);
        }

        function calculateSleepBlocks(dayData, dateStr) {
            const blocks = [];
            const bedtime = new Date(dayData.bedtime);
            const wakeTime = new Date(dayData.wakeTime);
            
            const bedtimeHour = bedtime.getHours();
            const wakeTimeHour = wakeTime.getHours();
            const wakeTimeMinute = wakeTime.getMinutes();
            
            // Night sleep from midnight to wake time
            if (wakeTimeHour > 0 || wakeTimeMinute > 0) {
                const startPercent = 0;
                const endPercent = ((wakeTimeHour * 60 + wakeTimeMinute) / (24 * 60)) * 100;
                
                blocks.push({
                    type: 'night',
                    top: startPercent,
                    height: endPercent - startPercent,
                    time: `Sleep until ${wakeTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`
                });
            }
            
            // Night sleep from bedtime to midnight
            if (bedtimeHour >= 18 || bedtimeHour < 6) {
                const bedtimeMinute = bedtime.getMinutes();
                const startPercent = ((bedtimeHour * 60 + bedtimeMinute) / (24 * 60)) * 100;
                const endPercent = 100;
                
                if (startPercent < endPercent) {
                    blocks.push({
                        type: 'night',
                        top: startPercent,
                        height: endPercent - startPercent,
                        time: `Bedtime ${bedtime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`
                    });
                }
            }
            
            return blocks;
        }

        function calculateNapBlock(nap, dateStr) {
            if (!nap || !nap.start || !nap.end) return null;
            
            // Naps are saved as time strings like "10:30", need to convert to full datetime
            const startParts = nap.start.split(':');
            const endParts = nap.end.split(':');
            
            if (startParts.length !== 2 || endParts.length !== 2) return null;
            
            const startHour = parseInt(startParts[0]);
            const startMinute = parseInt(startParts[1]);
            const endHour = parseInt(endParts[0]);
            const endMinute = parseInt(endParts[1]);
            
            if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) return null;
            
            const startPercent = ((startHour * 60 + startMinute) / (24 * 60)) * 100;
            const endPercent = ((endHour * 60 + endMinute) / (24 * 60)) * 100;
            
            // Format times for display
            const startHour12 = startHour === 0 ? 12 : startHour > 12 ? startHour - 12 : startHour;
            const endHour12 = endHour === 0 ? 12 : endHour > 12 ? endHour - 12 : endHour;
            const startAmpm = startHour >= 12 ? 'PM' : 'AM';
            const endAmpm = endHour >= 12 ? 'PM' : 'AM';
            
            const startTimeStr = `${startHour12}:${startMinute.toString().padStart(2, '0')} ${startAmpm}`;
            const endTimeStr = `${endHour12}:${endMinute.toString().padStart(2, '0')} ${endAmpm}`;
            
            return {
                type: 'nap',
                top: startPercent,
                height: endPercent - startPercent,
                time: `${startTimeStr} - ${endTimeStr}`,
                duration: nap.duration || `${nap.durationMinutes}m`,
                location: nap.location
            };
        }

        function createSleepBlock(block) {
            if (!block || typeof block.top !== 'number' || typeof block.height !== 'number') {
                return ''; // Skip invalid blocks
            }
            
            const color = block.type === 'night' ? 'rgba(59, 130, 246, 0.8)' : 'rgba(147, 197, 253, 0.8)';
            const borderColor = block.type === 'night' ? 'rgba(37, 99, 235, 1)' : 'rgba(59, 130, 246, 1)';
            
            let title = block.time || '';
            if (block.duration) title += `\n${block.duration}`;
            if (block.location) title += `\n${block.location}`;
            
            // Escape quotes and replace newlines with actual line breaks for HTML title
            const escapedTitle = title.replace(/"/g, '&quot;').replace(/\n/g, '&#10;');
            
            // Create onclick message for mobile
            let onclickMsg = block.time || '';
            if (block.duration) onclickMsg += '\\nDuration: ' + block.duration;
            if (block.location) {
                const locationEmoji = {
                    'crib': 'üõèÔ∏è Crib',
                    'stroller': 'üöº Stroller',
                    'car': 'üöó Car',
                    'carrier': 'üë∂ Carrier',
                    'contact': 'ü§± Contact',
                    'other': 'üìç Other'
                };
                onclickMsg += '\\nLocation: ' + (locationEmoji[block.location] || block.location);
            }
            const escapedOnclick = onclickMsg.replace(/'/g, "\\'");
            
            return `
                <div style="
                    position: absolute;
                    top: ${block.top}%;
                    height: ${block.height}%;
                    left: 2px;
                    right: 2px;
                    background: ${color};
                    border: 1px solid ${borderColor};
                    border-radius: 4px;
                    cursor: pointer;
                " title="${escapedTitle}" onclick="alert('${escapedOnclick}')"></div>
            `;
        }

        function createWakeupBlock(block) {
            if (!block || typeof block.top !== 'number' || typeof block.height !== 'number') {
                return ''; // Skip invalid blocks
            }
            
            // Escape quotes for HTML title attribute
            const title = (block.time || '').replace(/"/g, '&quot;');
            const escapedOnclick = (block.time || '').replace(/'/g, "\\'");
            
            return `
                <div style="
                    position: absolute;
                    top: ${block.top}%;
                    height: ${block.height}%;
                    left: 2px;
                    right: 2px;
                    background: repeating-linear-gradient(
                        45deg,
                        #fef3c7,
                        #fef3c7 5px,
                        #fde68a 5px,
                        #fde68a 10px
                    );
                    border: 1px solid #f59e0b;
                    border-radius: 4px;
                    cursor: pointer;
                    z-index: 10;
                " title="${title}" onclick="alert('${escapedOnclick}')"></div>
            `;
        }

        function calculateWakeupBlock(wakeup) {
            if (!wakeup.start || !wakeup.durationMinutes) return null;
            
            // Parse time string (format: "HH:MM")
            const timeParts = wakeup.start.split(':');
            if (timeParts.length !== 2) return null;
            
            const startHour = parseInt(timeParts[0]);
            const startMinute = parseInt(timeParts[1]);
            
            if (isNaN(startHour) || isNaN(startMinute)) return null;
            
            const startPercent = ((startHour * 60 + startMinute) / (24 * 60)) * 100;
            const heightPercent = (wakeup.durationMinutes / (24 * 60)) * 100;
            
            // Format time for display
            const hour12 = startHour === 0 ? 12 : startHour > 12 ? startHour - 12 : startHour;
            const ampm = startHour >= 12 ? 'PM' : 'AM';
            const timeStr = `${hour12}:${startMinute.toString().padStart(2, '0')} ${ampm}`;
            
            return {
                top: startPercent,
                height: heightPercent,
                time: `Wake-up: ${wakeup.durationMinutes}m at ${timeStr}`
            };
        }

        function calculateTotalSleep(dayData) {
            if (!dayData) return '0.0';
            
            let total = 0;
            
            // Night sleep
            if (dayData.bedtime && dayData.wakeTime) {
                const bedtime = new Date(dayData.bedtime);
                const wakeTime = new Date(dayData.wakeTime);
                
                if (!isNaN(bedtime.getTime()) && !isNaN(wakeTime.getTime())) {
                    let diff = wakeTime - bedtime;
                    if (diff < 0) diff += 24 * 60 * 60 * 1000;
                    total += diff / (1000 * 60 * 60);
                    
                    // Subtract wake-up time
                    if (dayData.wakeups && dayData.wakeups.length > 0) {
                        dayData.wakeups.forEach(wakeup => {
                            if (wakeup.durationMinutes) {
                                total -= wakeup.durationMinutes / 60;
                            }
                        });
                    }
                }
            }
            
            // Naps - handle both formats
            if (dayData.naps && dayData.naps.length > 0) {
                dayData.naps.forEach(nap => {
                    if (nap.durationMinutes) {
                        // Use stored duration
                        total += nap.durationMinutes / 60;
                    } else if (nap.start && nap.end) {
                        // Calculate from start/end
                        const start = new Date(nap.start);
                        const end = new Date(nap.end);
                        if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                            const diff = end - start;
                            total += diff / (1000 * 60 * 60);
                        }
                    }
                });
            }
            
            return total.toFixed(1);
        }

        // Settings Tab Functions
        function loadSettingsTab() {
            const name = localStorage.getItem('baby-name') || '';
            const dob = localStorage.getItem('baby-dob') || '';
            const bedtime = localStorage.getItem('preferred-bedtime') || '';
            
            document.getElementById('settings-name').value = name;
            document.getElementById('settings-dob').value = dob;
            document.getElementById('settings-bedtime').value = bedtime;
        }

        // Navigation Menu Functions
        function toggleNavMenu() {
            const menu = document.getElementById('nav-menu');
            const overlay = document.getElementById('nav-overlay');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function switchTabFromMenu(tabName) {
            // Update active state in nav menu
            document.querySelectorAll('.nav-menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Switch the tab
            switchTab(tabName);
            
            // Close the menu
            toggleNavMenu();
        }

        function openSettingsFromNav() {
            toggleNavMenu();
            setTimeout(() => {
                toggleSettingsMenu();
            }, 300); // Wait for nav menu to close
        }

        function updateBabySettings() {
            const name = document.getElementById('settings-name').value;
            const dob = document.getElementById('settings-dob').value;
            const bedtime = document.getElementById('settings-bedtime').value;
            
            if (name && dob) {
                localStorage.setItem('baby-name', name);
                localStorage.setItem('baby-dob', dob);
                if (bedtime) {
                    localStorage.setItem('preferred-bedtime', bedtime);
                }
                updateBabyDisplay();
                updateNextSleepWindow();
                updateNapAlert();
                alert('‚úÖ Settings saved!');
            } else {
                alert('Please enter both name and date of birth');
            }
        }

        // Backup & Restore Functions
        function exportData() {
            // Gather all data from localStorage
            const allData = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            // Create JSON file
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            // Use baby name and date for filename
            const babyName = localStorage.getItem('baby-name') || 'Baby';
            const date = new Date().toISOString().split('T')[0];
            link.download = `${babyName}-sleep-backup-${date}.json`;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup downloaded! Save it somewhere safe.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (confirm('‚ö†Ô∏è This will overwrite your current data. Continue?')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Clear existing data
                        localStorage.clear();
                        
                        // Import all data
                        for (const key in data) {
                            localStorage.setItem(key, data[key]);
                        }
                        
                        alert('‚úÖ Data restored successfully!');
                        location.reload(); // Refresh the page to show imported data
                    } catch (error) {
                        alert('‚ùå Error importing data. Make sure you selected a valid backup file.');
                    }
                };
                reader.readAsText(file);
            }
            
            // Reset file input
            event.target.value = '';
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (menu.classList.contains('active')) {
                loadSettingsTab();
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you ABSOLUTELY SURE? This will delete ALL sleep data permanently!')) {
                if (confirm('‚ö†Ô∏è Last chance! This cannot be undone. Delete everything?')) {
                    localStorage.clear();
                    alert('‚úÖ All data cleared.');
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>
